<!DOCTYPE html>
<html>
<head>
    <title>Spotify App Setup Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .step { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .success { background: #155724; border: 1px solid #28a745; }
        .error { background: #721c24; border: 1px solid #dc3545; }
        .warning { background: #856404; border: 1px solid #ffc107; }
        button { background: #1db954; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #1ed760; }
        .code { background: #333; padding: 10px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Spotify App Setup Test</h1>
        
        <div class="step">
            <h2>Step 1: Check Environment Variables</h2>
            <p>Testing if environment variables are loaded...</p>
            <div id="env-check">Loading...</div>
        </div>

        <div class="step">
            <h2>Step 2: Update Spotify App Settings</h2>
            <p><strong>Important:</strong> You need to add this redirect URI to your Spotify app:</p>
            <div class="code">http://localhost:3000/api/auth/callback</div>
            <p>
                1. Go to <a href="https://developer.spotify.com/dashboard" target="_blank">Spotify Developer Dashboard</a><br>
                2. Click on your app<br>
                3. Click "Edit Settings"<br>
                4. Add the redirect URI above<br>
                5. Click "Save"
            </p>
        </div>

        <div class="step">
            <h2>Step 3: Test Authentication</h2>
            <p>Once you've updated the Spotify app settings, test the login:</p>
            <button onclick="testAuth()">Test Spotify Login</button>
            <div id="auth-result"></div>
        </div>

        <div class="step">
            <h2>Step 4: Test Playlist Generation</h2>
            <p>After successful login, test playlist generation:</p>
            <button onclick="testPlaylist()">Test Playlist Generation</button>
            <div id="playlist-result"></div>
        </div>
    </div>

    <script>
        // Check environment variables
        fetch('/api/test')
            .then(r => r.json())
            .then(data => {
                document.getElementById('env-check').innerHTML = 
                    `<div class="success">‚úÖ API is working! Available moods: ${data.availableMoods.join(', ')}</div>`;
            })
            .catch(err => {
                document.getElementById('env-check').innerHTML = 
                    `<div class="error">‚ùå API Error: ${err.message}</div>`;
            });

        function testAuth() {
            document.getElementById('auth-result').innerHTML = '<p>Redirecting to Spotify...</p>';
            window.location.href = '/api/auth';
        }

        function testPlaylist() {
            const result = document.getElementById('playlist-result');
            result.innerHTML = '<p>Testing playlist generation...</p>';
            
            fetch('/api/token')
                .then(r => r.json())
                .then(tokenData => {
                    if (!tokenData.access_token) {
                        result.innerHTML = '<div class="error">‚ùå Please login first</div>';
                        return;
                    }
                    
                    return fetch('/api/create-playlist', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mood: 'happy' })
                    });
                })
                .then(r => r.json())
                .then(data => {
                    if (data.playlistId) {
                        result.innerHTML = `<div class="success">‚úÖ Playlist created! ID: ${data.playlistId}</div>`;
                    } else {
                        result.innerHTML = `<div class="error">‚ùå Error: ${data.error || 'Unknown error'}</div>`;
                    }
                })
                .catch(err => {
                    result.innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
                });
        }

        // Check if user is already logged in
        fetch('/api/token')
            .then(r => r.json())
            .then(data => {
                if (data.access_token) {
                    document.getElementById('auth-result').innerHTML = 
                        '<div class="success">‚úÖ Already logged in to Spotify!</div>';
                }
            })
            .catch(() => {});
    </script>
</body>
</html>
